<!-- GanttChart.WPF/Views/MainWindow.xaml -->
<Window x:Class="Wpf.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:Wpf.Controls"
        xmlns:viewModels="clr-namespace:Wpf.ViewModels"
        xmlns:icon="clr-namespace:Material.Icons.WPF;assembly=Material.Icons.WPF"
        xmlns:converters="clr-namespace:Wpf.Converters"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}"
        Height="700" 
        Width="1200"
        MinHeight="500"
        MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}"
        d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel, IsDesignTimeCreatable=False}">

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ГОРЯЧИЕ КЛАВИШИ                                                 -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Control" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="O" Modifiers="Control" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveProjectCommand}"/>
        <KeyBinding Key="S" Modifiers="Control+Shift" Command="{Binding SaveProjectAsCommand}"/>
        <KeyBinding Key="OemPlus" Modifiers="Control" Command="{Binding ZoomInCommand}"/>
        <KeyBinding Key="OemMinus" Modifiers="Control" Command="{Binding ZoomOutCommand}"/>
        <KeyBinding Key="D0" Modifiers="Control" Command="{Binding ZoomResetCommand}"/>
        <KeyBinding Key="R" Modifiers="Control" Command="{Binding ManageResourcesCommand}"/>
        <KeyBinding Key="R" Modifiers="Control+Shift" Command="{Binding AssignResourcesCommand}"/>
        <KeyBinding Key="T" Modifiers="Control" Command="{Binding AddTaskCommand}"/>
        <KeyBinding Key="T" Modifiers="Control+Shift" Command="{Binding AddSubtaskCommand}"/>
        <KeyBinding Key="G" Modifiers="Control" Command="{Binding MakeGroupCommand}"/>
        <KeyBinding Key="G" Modifiers="Control+Shift" Command="{Binding UngroupCommand}"/>
        <KeyBinding Key="Delete" Command="{Binding DeleteTaskCommand}"/>
    </Window.InputBindings>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ОСНОВНОЙ LAYOUT                                                 -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <Window.Resources>
        <converters:LevelToMarginConverter x:Key="LevelToMarginConverter" IndentSize="16"/>
        <converters:IsSplitToVisibilityConverter x:Key="IsSplitToVisibilityConverter"/>
        <converters:CountToBoolConverter x:Key="CountToBoolConverter"/>
        <ContextMenu x:Key="TaskContextMenu" 
                     DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
            <MenuItem Header="Добавить задачу" 
                      Command="{Binding AddTaskCommand}"/>
            <MenuItem Header="Добавить подзадачу" 
                      Command="{Binding AddSubtaskCommand}"/>
            <Separator/>
            <MenuItem Header="Создать группу" 
                      Command="{Binding MakeGroupCommand}"/>
            <MenuItem Header="Добавить в группу..." 
                      ItemsSource="{Binding AvailableGroups}"
                      IsEnabled="{Binding AvailableGroups.Count, Converter={StaticResource CountToBoolConverter}}">
                <MenuItem.ItemContainerStyle>
                    <Style TargetType="MenuItem">
                        <Setter Property="Header" Value="{Binding Name}"/>
                        <Setter Property="Command" Value="{Binding DataContext.AddToGroupCommand, 
                    RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                        <Setter Property="CommandParameter" Value="{Binding}"/>
                    </Style>
                </MenuItem.ItemContainerStyle>
            </MenuItem>
            <MenuItem Header="Убрать из группы" 
                      Command="{Binding RemoveFromGroupCommand}"/>
            <MenuItem Header="Разгруппировать" 
                      Command="{Binding UngroupCommand}"/>
            <Separator/>
            <MenuItem Header="Назначить ресурсы..." 
                      Command="{Binding AssignResourcesCommand}"/>
            <Separator/>
            <MenuItem Header="Удалить" 
                      Command="{Binding DeleteTaskCommand}"
                      Foreground="#D32F2F"/>
        </ContextMenu>
    </Window.Resources>
    <!-- Контекстное меню для задач -->
    <DockPanel LastChildFill="True">
        <!-- ─────────────────────────────────────────────────────────── -->
        <!-- MENU                                                        -->
        <!-- ─────────────────────────────────────────────────────────── -->
        <Menu DockPanel.Dock="Top" Style="{StaticResource MainMenuStyle}">
            
            <!-- File -->
            <MenuItem Header="_Файл">
                <MenuItem Header="Создать _демо-проект" 
                          Command="{Binding CreateDemoProjectCommand}"/>
                <MenuItem Header="_Новый" 
                          Command="{Binding NewProjectCommand}"
                          InputGestureText="Ctrl+N"/>
                <MenuItem Header="_Открыть..." 
                          Command="{Binding OpenProjectCommand}"
                          InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="_Сохранить" 
                          Command="{Binding SaveProjectCommand}"
                          InputGestureText="Ctrl+S"/>
                <MenuItem Header="Сохранить _как..." 
                          Command="{Binding SaveProjectAsCommand}"
                          InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="_Выход" 
                          Command="{Binding ExitApplicationCommand}"
                          InputGestureText="Alt+F4"/>
            </MenuItem>

            <!-- View -->
            <MenuItem Header="_Вид">
                <MenuItem Header="Увеличить" 
                          Command="{Binding ZoomInCommand}"
                          InputGestureText="Ctrl++"/>
                <MenuItem Header="Уменьшить" 
                          Command="{Binding ZoomOutCommand}"
                          InputGestureText="Ctrl+-"/>
                <MenuItem Header="Сбросить масштаб" 
                          Command="{Binding ZoomResetCommand}"
                          InputGestureText="Ctrl+0"/>
                <Separator/>
                <MenuItem Header="Показать связи" IsCheckable="True" IsChecked="True"/>
                <MenuItem Header="Показать резерв" IsCheckable="True" IsChecked="True"/>
                <Separator/>
                <MenuItem Header="Развернуть всё" 
                          Command="{Binding ExpandAllCommand}"
                          InputGestureText="Ctrl+E"/>
                <MenuItem Header="Свернуть всё" 
                          Command="{Binding CollapseAllCommand}"/>
                <Separator/>
                <MenuItem Header="Показать части split-задач" 
                          IsCheckable="True"
                          IsChecked="{Binding ShowAllSplitParts}"/>
            </MenuItem>
            
            <!-- Edit Menu -->
            <MenuItem Header="_Правка">
                <MenuItem Header="Добавить задачу" 
                          Command="{Binding AddTaskCommand}"
                          InputGestureText="Ctrl+T"/>
                <MenuItem Header="Добавить подзадачу" 
                          Command="{Binding AddSubtaskCommand}"
                          InputGestureText="Ctrl+Shift+T"/>
                <Separator/>
                <MenuItem Header="Создать группу" 
                          Command="{Binding MakeGroupCommand}"
                          InputGestureText="Ctrl+G"/>
                <MenuItem Header="Разгруппировать" 
                          Command="{Binding UngroupCommand}"
                          InputGestureText="Ctrl+Shift+G"/>
                <Separator/>
                <MenuItem Header="Удалить" 
                          Command="{Binding DeleteTaskCommand}"
                          InputGestureText="Del"/>
            </MenuItem>

            <!-- Resources -->
            <MenuItem Header="_Ресурсы">
                <MenuItem Header="Управление ресурсами..." 
                          Command="{Binding ManageResourcesCommand}"
                          InputGestureText="Ctrl+R"/>
                <Separator/>
                <MenuItem Header="Назначить на задачу..." 
                          Command="{Binding AssignResourcesCommand}"
                          InputGestureText="Ctrl+Shift+R"/>
            </MenuItem>

            <!-- Help -->
            <MenuItem Header="_Справка">
                <MenuItem Header="О программе" 
                          Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ─────────────────────────────────────────────────────────── -->
        <!-- STATUSBAR                                                   -->
        <!-- ─────────────────────────────────────────────────────────── -->
        <StatusBar DockPanel.Dock="Bottom" Style="{StaticResource MainStatusBarStyle}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" Style="{StaticResource StatusBarTextStyle}"/>
            </StatusBarItem>
            
            <Separator/>
            
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Задач: " Style="{StaticResource StatusBarTextStyle}"/>
                    <TextBlock Text="{Binding TaskCount}" Style="{StaticResource StatusBarTextStyle}" Margin="0"/>
                </StackPanel>
            </StatusBarItem>
            
            <Separator/>
            
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Масштаб: " Style="{StaticResource StatusBarTextStyle}"/>
                    <TextBlock Text="{Binding ZoomLevel, StringFormat={}{0}%}" 
                               Style="{StaticResource StatusBarTextStyle}" 
                               Margin="0"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <!-- ─────────────────────────────────────────────────────────── -->
        <!-- MAIN CONTENT: Sidebar | Splitter | Chart                    -->
        <!-- ─────────────────────────────────────────────────────────── -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="200" MaxWidth="500"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="400"/>
            </Grid.ColumnDefinitions>

            <!-- SIDEBAR: TreeView + DataGrid -->
            <Grid Grid.Column="0" Background="{StaticResource SidebarBackgroundBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" MinHeight="100" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="2*" MinHeight="150" />
                </Grid.RowDefinitions>

                <!-- TreeView (иерархия задач) -->
                <DockPanel Grid.Row="0">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Структура проекта"
                               FontWeight="SemiBold"
                               Margin="8,8,8,4" />
                    <TreeView x:Name="TaskTreeView"
                              Style="{StaticResource TaskTreeViewStyle}"
                              ItemsSource="{Binding RootTasks}"
                              SelectedItemChanged="TaskTreeView_SelectedItemChanged"
                              ContextMenu="{StaticResource TaskContextMenu}"
                              Margin="4">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem">
                                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                                <Setter Property="Padding" Value="2" />
                            </Style>
                        </TreeView.ItemContainerStyle>
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <Border Background="Transparent"
                                        MouseLeftButtonDown="TreeViewItem_MouseLeftButtonDown"
                                        ToolTip="{Binding ToolTip}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Иконка -->
                                        <icon:MaterialIcon Grid.Column="0"
                                                           Kind="{Binding IconKind}"
                                                           Width="16" Height="16"
                                                           Margin="0,0,6,0"
                                                           Foreground="{StaticResource TextSecondaryBrush}" />

                                        <!-- Имя задачи -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   VerticalAlignment="Center" />

                                        <!-- Toggle для split-частей -->
                                        <Button Grid.Column="2"
                                                Visibility="{Binding IsSplitRoot, Converter={StaticResource IsSplitToVisibilityConverter}}"
                                                Command="{Binding ToggleShowPartsCommand}"
                                                ToolTip="Показать/скрыть части"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Padding="2"
                                                Margin="4,0,0,0">
                                            <icon:MaterialIcon Width="14" Height="14"
                                                               Foreground="{StaticResource TextSecondaryBrush}">
                                                <icon:MaterialIcon.Style>
                                                    <Style TargetType="icon:MaterialIcon">
                                                        <Setter Property="Kind" Value="ChevronRight" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ShowParts}" Value="True">
                                                                <Setter Property="Kind" Value="ChevronDown" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </icon:MaterialIcon.Style>
                                            </icon:MaterialIcon>
                                        </Button>
                                    </Grid>
                                </Border>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>

                <!-- Горизонтальный splitter -->
                <GridSplitter Grid.Row="1"
                              Height="5"
                              HorizontalAlignment="Stretch"
                              Background="{StaticResource GridLineBrush}"
                              Cursor="SizeNS" />

                <!-- DataGrid (таблица задач) -->
                <DockPanel Grid.Row="2">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Список задач"
                               FontWeight="SemiBold"
                               Margin="8,8,8,4" />
                    <DataGrid x:Name="TaskDataGrid"
                              Style="{StaticResource TaskDataGridStyle}"
                              ItemsSource="{Binding FlatTasks}"
                              SelectedItem="{Binding SelectedTaskItem, Mode=TwoWay}"
                              ContextMenu="{StaticResource TaskContextMenu}"
                              Margin="4">
                        <DataGrid.Columns>
                            <!-- Название с иконкой и отступом -->
                            <DataGridTemplateColumn Header="Название" Width="*" MinWidth="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal"
                                                    Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}">
                                            <icon:MaterialIcon Kind="{Binding IconKind}"
                                                               Width="14" Height="14"
                                                               Margin="0,0,4,0"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                               VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding Name}"
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}"
                                                 BorderThickness="0"
                                                 Padding="0" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- Дата начала -->
                            <DataGridTemplateColumn Header="Начало" Width="90">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding StartDate, StringFormat=dd.MM.yyyy}"
                                                   HorizontalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <DatePicker
                                            SelectedDate="{Binding StartDate, UpdateSourceTrigger=PropertyChanged}"
                                            BorderThickness="0" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- Длительность -->
                            <DataGridTemplateColumn Header="Дни" Width="50">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding DurationDays}"
                                                   HorizontalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding DurationDays, UpdateSourceTrigger=PropertyChanged}"
                                                 BorderThickness="0"
                                                 HorizontalContentAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- Процент выполнения -->
                            <DataGridTemplateColumn Header="%" Width="55">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <ProgressBar Value="{Binding CompletePercent, Mode=OneWay}"
                                                         Maximum="100"
                                                         Height="14"
                                                         Foreground="{StaticResource AccentBrush}"
                                                         Background="{StaticResource GridLineBrush}" />
                                            <TextBlock Text="{Binding CompletePercent, StringFormat={}{0}%}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       FontSize="10" />
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <Slider Value="{Binding CompletePercent, UpdateSourceTrigger=PropertyChanged}"
                                                Minimum="0"
                                                Maximum="100"
                                                TickFrequency="10"
                                                IsSnapToTickEnabled="True" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Grid>

            <!-- SPLITTER -->
            <GridSplitter Grid.Column="1" Style="{StaticResource VerticalSplitterStyle}"/>

            <!-- CHART AREA -->
            <Border Grid.Column="2" 
                    Background="{StaticResource BackgroundBrush}"
                    BorderBrush="{StaticResource GridLineBrush}"
                    BorderThickness="1,0,0,0">
    
                <controls:GanttChartControl 
                    x:Name="GanttChart"
                    ProjectManager="{Binding ProjectManager}"
                    ZoomLevel="{Binding ZoomLevel}"
                    SelectedTask="{Binding SelectedTask, Mode=TwoWay}"
                    ResourceService="{Binding ResourceService}"
                    TaskDoubleClicked="GanttChart_TaskDoubleClicked"/>
            </Border>
        </Grid>
    </DockPanel>
</Window>