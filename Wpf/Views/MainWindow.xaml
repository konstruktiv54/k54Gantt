<!-- GanttChart.WPF/Views/MainWindow.xaml -->
<Window x:Class="Wpf.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:Wpf.Controls"
        xmlns:viewModels="clr-namespace:Wpf.ViewModels"
        xmlns:icon="clr-namespace:Material.Icons.WPF;assembly=Material.Icons.WPF"
        xmlns:converters="clr-namespace:Wpf.Converters"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}"
        Height="700" 
        Width="1200"
        MinHeight="500"
        MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}"
        d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel, IsDesignTimeCreatable=False}">

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ГОРЯЧИЕ КЛАВИШИ                                                 -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Control" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="O" Modifiers="Control" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveProjectCommand}"/>
        <KeyBinding Key="S" Modifiers="Control+Shift" Command="{Binding SaveProjectAsCommand}"/>
        <KeyBinding Key="OemPlus" Modifiers="Control" Command="{Binding ZoomInCommand}"/>
        <KeyBinding Key="OemMinus" Modifiers="Control" Command="{Binding ZoomOutCommand}"/>
        <KeyBinding Key="D0" Modifiers="Control" Command="{Binding ZoomResetCommand}"/>
        <KeyBinding Key="R" Modifiers="Control" Command="{Binding ManageResourcesCommand}"/>
        <KeyBinding Key="R" Modifiers="Control+Shift" Command="{Binding AssignResourcesCommand}"/>
        <KeyBinding Key="T" Modifiers="Control" Command="{Binding AddTaskCommand}"/>
        <KeyBinding Key="T" Modifiers="Control+Shift" Command="{Binding AddSubtaskCommand}"/>
        <KeyBinding Key="G" Modifiers="Control" Command="{Binding MakeGroupCommand}"/>
        <KeyBinding Key="G" Modifiers="Control+Shift" Command="{Binding UngroupCommand}"/>
        <KeyBinding Key="Delete" Command="{Binding DeleteTaskCommand}"/>
        <KeyBinding Key="C" Modifiers="Ctrl" Command="{Binding CopyTaskCommand}" />
        <KeyBinding Key="V" Modifiers="Ctrl" Command="{Binding PasteTaskCommand}" />
        <KeyBinding Key="F2" Command="{Binding EditNoteCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Y" Modifiers="Ctrl" Command="{Binding RedoCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl+Shift" Command="{Binding RedoCommand}" />
    </Window.InputBindings>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- ОСНОВНОЙ LAYOUT                                                 -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <Window.Resources>
        <converters:LevelToMarginConverter x:Key="LevelToMarginConverter" IndentSize="16"/>
        <converters:IsSplitToVisibilityConverter x:Key="IsSplitToVisibilityConverter"/>
        <converters:CountToBoolConverter x:Key="CountToBoolConverter"/>
        <ContextMenu x:Key="TaskContextMenu" 
                     DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
            <MenuItem Header="Добавить задачу" 
                      Command="{Binding AddTaskCommand}"/>
            <MenuItem Header="Добавить подзадачу" 
                      Command="{Binding AddSubtaskCommand}"/>
            <Separator/>
            <MenuItem Header="Создать группу" 
                      Command="{Binding MakeGroupCommand}"/>
            <MenuItem Header="Добавить в группу..." 
                      ItemsSource="{Binding AvailableGroups}"
                      IsEnabled="{Binding AvailableGroups.Count, Converter={StaticResource CountToBoolConverter}}">
                <MenuItem.ItemContainerStyle>
                    <Style TargetType="MenuItem">
                        <Setter Property="Header" Value="{Binding Name}"/>
                        <Setter Property="Command" Value="{Binding DataContext.AddToGroupCommand, 
                    RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                        <Setter Property="CommandParameter" Value="{Binding}"/>
                    </Style>
                </MenuItem.ItemContainerStyle>
            </MenuItem>
            <MenuItem Header="Убрать из группы" 
                      Command="{Binding RemoveFromGroupCommand}"/>
            <MenuItem Header="Разгруппировать" 
                      Command="{Binding UngroupCommand}"/>
            <Separator/>
            <MenuItem Header="Назначить ресурсы..." 
                      Command="{Binding AssignResourcesCommand}"/>
            <Separator/>
            <MenuItem Header="Редактировать заметку..." 
                      Command="{Binding EditNoteCommand}"
                      InputGestureText="F2">
                <MenuItem.Icon>
                    <icon:MaterialIcon Kind="NoteEdit" Width="16" Height="16"/>
                </MenuItem.Icon>
            </MenuItem>
            <Separator/>
            <MenuItem Header="Удалить" 
                      Command="{Binding DeleteTaskCommand}"
                      Foreground="#D32F2F"/>
        </ContextMenu>
    </Window.Resources>
    <!-- Контекстное меню для задач -->
    <DockPanel LastChildFill="True">
        <!-- ─────────────────────────────────────────────────────────── -->
        <!-- MENU                                                        -->
        <!-- ─────────────────────────────────────────────────────────── -->
        <Menu DockPanel.Dock="Top" Style="{StaticResource MainMenuStyle}">
            
            <!-- File -->
            <MenuItem Header="_Файл">
                <MenuItem Header="Создать _демо-проект" 
                          Command="{Binding CreateDemoProjectCommand}"/>
                <MenuItem Header="_Новый" 
                          Command="{Binding NewProjectCommand}"
                          InputGestureText="Ctrl+N"/>
                <MenuItem Header="_Открыть..." 
                          Command="{Binding OpenProjectCommand}"
                          InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="_Сохранить" 
                          Command="{Binding SaveProjectCommand}"
                          InputGestureText="Ctrl+S"/>
                <MenuItem Header="Сохранить _как..." 
                          Command="{Binding SaveProjectAsCommand}"
                          InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="_Выход" 
                          Command="{Binding ExitApplicationCommand}"
                          InputGestureText="Alt+F4"/>
            </MenuItem>

            <!-- View -->
            <MenuItem Header="_Вид">
                <MenuItem Header="Увеличить" 
                          Command="{Binding ZoomInCommand}"
                          InputGestureText="Ctrl++"/>
                <MenuItem Header="Уменьшить" 
                          Command="{Binding ZoomOutCommand}"
                          InputGestureText="Ctrl+-"/>
                <MenuItem Header="Сбросить масштаб" 
                          Command="{Binding ZoomResetCommand}"
                          InputGestureText="Ctrl+0"/>
                <Separator/>
                <MenuItem Header="Показать связи" IsCheckable="True" IsChecked="True"/>
                <MenuItem Header="Показать резерв" IsCheckable="True" IsChecked="True"/>
                <Separator/>
                <MenuItem Header="Развернуть всё" 
                          Command="{Binding ExpandAllCommand}"
                          InputGestureText="Ctrl+E"/>
                <MenuItem Header="Свернуть всё" 
                          Command="{Binding CollapseAllCommand}"/>
                <Separator/>
                <MenuItem Header="Показать части split-задач" 
                          IsCheckable="True"
                          IsChecked="{Binding ShowAllSplitParts}"/>
            </MenuItem>
            
            <!-- Edit Menu -->
            <MenuItem Header="_Правка">
                <!-- Undo -->
                <MenuItem Header="_Отменить" 
                          Command="{Binding UndoCommand}"
                          InputGestureText="Ctrl+Z">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Undo" />
                    </MenuItem.Icon>
                    <MenuItem.ToolTip>
                        <TextBlock>
                            <Run Text="Отменить: "/>
                            <Run Text="{Binding UndoDescription, FallbackValue='(нет действий)'}" />
                        </TextBlock>
                    </MenuItem.ToolTip>
                </MenuItem>
    
                <!-- Redo -->
                <MenuItem Header="По_вторить" 
                          Command="{Binding RedoCommand}"
                          InputGestureText="Ctrl+Y">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Redo" />
                    </MenuItem.Icon>
                    <MenuItem.ToolTip>
                        <TextBlock>
                            <Run Text="Повторить: "/>
                            <Run Text="{Binding RedoDescription, FallbackValue='(нет действий)'}" />
                        </TextBlock>
                    </MenuItem.ToolTip>
                </MenuItem>
    
                <Separator />
                <MenuItem Header="Добавить задачу" 
                          Command="{Binding AddTaskCommand}"
                          InputGestureText="Ctrl+T"/>
                <MenuItem Header="Добавить подзадачу" 
                          Command="{Binding AddSubtaskCommand}"
                          InputGestureText="Ctrl+Shift+T"/>
                <Separator/>
                <MenuItem Header="Создать группу" 
                          Command="{Binding MakeGroupCommand}"
                          InputGestureText="Ctrl+G"/>
                <MenuItem Header="Разгруппировать" 
                          Command="{Binding UngroupCommand}"
                          InputGestureText="Ctrl+Shift+G"/>
                <Separator/>
                <MenuItem Header="_Копировать" 
                          Command="{Binding CopyTaskCommand}"
                          InputGestureText="Ctrl+C">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ContentCopy" />
                    </MenuItem.Icon>
                </MenuItem>
        
                <MenuItem Header="_Вставить" 
                          Command="{Binding PasteTaskCommand}"
                          InputGestureText="Ctrl+V">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ContentPaste" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="Удалить" 
                          Command="{Binding DeleteTaskCommand}"
                          InputGestureText="Del"/>
            </MenuItem>

            <!-- Resources -->
            <MenuItem Header="_Ресурсы">
                <MenuItem Header="Управление ресурсами..." 
                          Command="{Binding ManageResourcesCommand}"
                          InputGestureText="Ctrl+R"/>
                <Separator/>
                <MenuItem Header="Назначить на задачу..." 
                          Command="{Binding AssignResourcesCommand}"
                          InputGestureText="Ctrl+Shift+R"/>
            </MenuItem>
            
            <!-- Печать -->
            <MenuItem Header="Экспорт в PDF" Command="{Binding ExportToPdfCommand}" 
                      InputGestureText="Ctrl+P">
                <MenuItem.Icon>
                    <materialDesign:PackIcon Kind="FilePdfBox"/>
                </MenuItem.Icon>
            </MenuItem>

            <!-- Help -->
            <MenuItem Header="_Справка">
                <MenuItem Header="О программе" 
                          Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ─────────────────────────────────────────────────────────── -->
        <!-- STATUSBAR                                                   -->
        <!-- ─────────────────────────────────────────────────────────── -->
        <StatusBar DockPanel.Dock="Bottom" Style="{StaticResource MainStatusBarStyle}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" Style="{StaticResource StatusBarTextStyle}"/>
            </StatusBarItem>
            
            <Separator/>
            
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Задач: " Style="{StaticResource StatusBarTextStyle}"/>
                    <TextBlock Text="{Binding TaskCount}" Style="{StaticResource StatusBarTextStyle}" Margin="0"/>
                </StackPanel>
            </StatusBarItem>
            
            <Separator/>
            
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Масштаб: " Style="{StaticResource StatusBarTextStyle}"/>
                    <TextBlock Text="{Binding ZoomLevel, StringFormat={}{0}%}" 
                               Style="{StaticResource StatusBarTextStyle}" 
                               Margin="0"/>
                </StackPanel>
            </StatusBarItem>
            
            <Separator />
    
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Undo: " Foreground="Gray" />
                    <TextBlock Text="{Binding UndoRedoService.UndoCount}" />
                    <TextBlock Text=" | Redo: " Foreground="Gray" />
                    <TextBlock Text="{Binding UndoRedoService.RedoCount}" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

<!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ОСНОВНОЙ LAYOUT: 2 ряда × 3 колонки                             -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="100" MinHeight="24" 
                               MaxHeight="{Binding DataContext.EngagementStripMaxHeight, 
                               RelativeSource={RelativeSource AncestorType=Window}}"/>
            </Grid.RowDefinitions>
            
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="400" MinWidth="400" MaxWidth="550"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- SIDEBAR: DataGrid с задачами (Row 0, Column 0)              -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="0" Grid.Column="0"
                    Background="{StaticResource SidebarBackgroundBrush}"
                    BorderBrush="{StaticResource GridLineBrush}"
                    BorderThickness="0">
    
                <!-- DataGrid с задачами -->
                <DataGrid x:Name="TasksDataGrid"
                          ItemsSource="{Binding FlatTasks}"
                          SelectedItem="{Binding SelectedTaskItem, Mode=TwoWay}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          SelectionMode="Single"
                          SelectionUnit="FullRow"
                          GridLinesVisibility="Horizontal"
                          HorizontalGridLinesBrush="{StaticResource GridLineBrush}"
                          Background="{StaticResource SidebarBackgroundBrush}"
                          RowHeight="28"
                          ColumnHeaderHeight="50"
                          HeadersVisibility="Column"
                          VirtualizingPanel.ScrollUnit="Pixel"
                          ContextMenu="{StaticResource TaskContextMenu}">
                    <DataGrid.Resources>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGrid.Resources>
                    <DataGrid.Columns>
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Имя задачи с отступом по уровню                             -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTemplateColumn Header="Задача" Width="*" MinWidth="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal"
                                                    Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}">
                                            <!-- Иконка группы/задачи -->
                                            <icon:MaterialIcon Width="16" Height="16" Margin="0,0,4,0"
                                                               Foreground="{StaticResource TextSecondaryBrush}">
                                                <icon:MaterialIcon.Style>
                                                    <Style TargetType="icon:MaterialIcon">
                                                        <Setter Property="Kind" Value="CheckboxBlankCircleOutline" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsGroup}" Value="True">
                                                                <Setter Property="Kind" Value="FolderOutline" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsSplitRoot}" Value="True">
                                                                <Setter Property="Kind" Value="CallSplit" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </icon:MaterialIcon.Style>
                                            </icon:MaterialIcon>
                                            <TextBlock Text="{Binding Name}"
                                                       VerticalAlignment="Center"
                                                       TextTrimming="CharacterEllipsis" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}"
                                                 BorderThickness="0"
                                                 Padding="20,0,0,0" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Дата начала (DatePicker)                                    -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTemplateColumn Header="Старт" Width="60" SortMemberPath="StartDate">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding StartDate, StringFormat=dd.MM.yy}"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center"
                                                   Padding="2,0" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <DatePicker
                                            SelectedDate="{Binding StartDate, UpdateSourceTrigger=PropertyChanged}"
                                            BorderThickness="0"
                                            Padding="0"
                                            VerticalContentAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Длительность (дней)                                         -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTextColumn Width="60" IsReadOnly="True" Binding="{Binding DaysDisplay}">
                                <DataGridTextColumn.Header>
                                    <TextBlock Text="Дней&#x0a;(рабоч.)" TextAlignment="Center"/>
                                </DataGridTextColumn.Header>
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Center" />
                                        <Setter Property="VerticalAlignment" Value="Center" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Дата окончания (DatePicker)                                    -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTemplateColumn Header="Финиш" Width="60" SortMemberPath="EndDate">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding EndDate, StringFormat=dd.MM.yy}"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Center"
                                                   Padding="2,0" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <DatePicker
                                            SelectedDate="{Binding EndDate, UpdateSourceTrigger=PropertyChanged}"
                                            BorderThickness="0"
                                            Padding="0"
                                            VerticalContentAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Прогресс (%)                                                -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTemplateColumn Header="%" Width="40" SortMemberPath="CompletePercent">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding CompletePercent, StringFormat={}{0}%}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- Дедлайн (DatePicker с возможностью очистки)                 -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <DataGridTemplateColumn Header="Дедлайн" Width="60" SortMemberPath="DeadlineDate">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- Текст даты или прочерк -->
                                            <TextBlock VerticalAlignment="Center"
                                                       HorizontalAlignment="Center"
                                                       Padding="2,0">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text"
                                                                Value="{Binding DeadlineDate, StringFormat=dd.MM.yy}" />
                                                        <Setter Property="Foreground"
                                                                Value="{StaticResource TextPrimaryBrush}" />
                                                        <Style.Triggers>
                                                            <!-- Если дедлайна нет — показываем прочерк -->
                                                            <DataTrigger Binding="{Binding HasDeadline}" Value="False">
                                                                <Setter Property="Text" Value="—" />
                                                                <Setter Property="Foreground"
                                                                        Value="{StaticResource TextSecondaryBrush}" />
                                                            </DataTrigger>
                                                            <!-- Если просрочено — красный цвет -->
                                                            <DataTrigger Binding="{Binding IsOverdue}" Value="True">
                                                                <Setter Property="Foreground" Value="#D32F2F" />
                                                                <Setter Property="FontWeight" Value="SemiBold" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <!-- DatePicker для выбора даты -->
                                            <DatePicker Grid.Column="0"
                                                        SelectedDate="{Binding DeadlineDate, UpdateSourceTrigger=PropertyChanged}"
                                                        BorderThickness="0"
                                                        Padding="0"
                                                        VerticalContentAlignment="Center" />

                                            <!-- Кнопка очистки дедлайна -->
                                            <Button Grid.Column="1"
                                                    Command="{Binding ClearDeadlineCommand}"
                                                    ToolTip="Удалить дедлайн"
                                                    Visibility="{Binding HasDeadline, Converter={StaticResource BoolToVisibilityConverter}}"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="2"
                                                    Margin="2,0,0,0"
                                                    Cursor="Hand">
                                                <icon:MaterialIcon Kind="Close" Width="12" Height="12"
                                                                   Foreground="#999" />
                                            </Button>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
            </Border>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- VERTICAL SPLITTER (Row 0, Column 1)                         -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <GridSplitter Grid.Row="0" Grid.RowSpan="3" Grid.Column="1" 
                          Style="{StaticResource VerticalSplitterStyle}"/>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- GANTT CHART (Row 0, Column 2)                               -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="0" Grid.Column="2"
                    Background="{StaticResource BackgroundBrush}"
                    BorderBrush="{StaticResource GridLineBrush}"
                    BorderThickness="0,0,0,1">

                <controls:GanttChartControl
                    x:Name="GanttChart"
                    Tag="{Binding}"
                    ProjectManager="{Binding ProjectManager}"
                    CalendarService="{Binding CalendarService}"
                    ResourceService="{Binding ResourceService}"
                    UndoRedoService="{Binding UndoRedoService}"
                    WorkingDaysCalculator="{Binding WorkingDaysCalculator}"
                    SelectedTask="{Binding SelectedTask, Mode=TwoWay}"
                    ZoomLevel="{Binding ZoomLevel, Mode=TwoWay}"
                    ColumnWidth="{Binding ColumnWidth}"
                    ShowRelations="True"
                    ShowTodayLine="True"
                    HighlightWeekends="True"
                    TaskDoubleClicked="GanttChart_TaskDoubleClicked">
                    <controls:GanttChartControl.ContextMenu>
                        <ContextMenu DataContext="{Binding PlacementTarget.Tag, RelativeSource={RelativeSource Self}}">
                            <MenuItem Header="Добавить задачу" Command="{Binding AddTaskCommand}"/>
                            <MenuItem Header="Добавить подзадачу" Command="{Binding AddSubtaskCommand}"/>
                            <Separator/>
                            <MenuItem Header="Создать группу" Command="{Binding MakeGroupCommand}"/>
                            <MenuItem Header="Добавить в группу..."
                                      ItemsSource="{Binding AvailableGroups}"
                                      IsEnabled="{Binding AvailableGroups.Count, Converter={StaticResource CountToBoolConverter}}">
                                <MenuItem.ItemContainerStyle>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Header" Value="{Binding Name}"/>
                                        <Setter Property="Command"
                                                Value="{Binding DataContext.AddToGroupCommand, 
                                                    RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                        <Setter Property="CommandParameter" Value="{Binding}"/>
                                    </Style>
                                </MenuItem.ItemContainerStyle>
                            </MenuItem>
                            <MenuItem Header="Убрать из группы" Command="{Binding RemoveFromGroupCommand}"/>
                            <MenuItem Header="Разгруппировать" Command="{Binding UngroupCommand}"/>
                            <Separator/>
                            <MenuItem Header="Назначить ресурсы..." Command="{Binding AssignResourcesCommand}"/>
                            <Separator/>
                            <MenuItem Header="Редактировать заметку..." 
                                      Command="{Binding EditNoteCommand}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="NoteEdit"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Удалить" Command="{Binding DeleteTaskCommand}" Foreground="#D32F2F"/>
                        </ContextMenu>
                    </controls:GanttChartControl.ContextMenu>
                </controls:GanttChartControl>
            </Border>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- HORIZONTAL SPLITTER (Row 1, spans all columns)              -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <GridSplitter Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                          Height="5"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Center"
                          Background="{StaticResource GridLineBrush}"
                          ResizeDirection="Rows"
                          Cursor="SizeNS"/>

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- RESOURCE NAMES (Row 2, Column 0)                            -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="2" Grid.Column="0"
                    Background="{StaticResource SidebarBackgroundBrush}"
                    BorderBrush="{StaticResource GridLineBrush}"
                    BorderThickness="0">
                <ScrollViewer x:Name="ResourceNamesScrollViewer"
                              VerticalScrollBarVisibility="Hidden"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding ResourceService.Resources}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Height="24" 
                                        BorderBrush="{StaticResource GridLineBrush}"
                                        BorderThickness="0,0,0,1"
                                        Padding="8,0"
                                        Background="{StaticResource SidebarBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Цветовой индикатор -->
                                        <Border Grid.Column="0" 
                                                Width="12" Height="12" 
                                                CornerRadius="2"
                                                Margin="0,0,6,0">
                                            <Border.Background>
                                                <SolidColorBrush Color="{Binding ColorHex, 
                                                    Converter={StaticResource HexToColorConverter}, 
                                                    FallbackValue=#4682B4}"/>
                                            </Border.Background>
                                        </Border>
                                        
                                        <!-- Имя ресурса -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   FontSize="11"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
             

            <!-- ═══════════════════════════════════════════════════════════ -->
            <!-- ENGAGEMENT TIMELINE (Row 2, Column 2)                       -->
            <!-- ═══════════════════════════════════════════════════════════ -->
            <Border Grid.Row="2" Grid.Column="2"
                    BorderBrush="{StaticResource GridLineBrush}"
                    BorderThickness="0">
                <controls:ResourceEngagementStrip
                    x:Name="EngagementStrip"
                    ResourceService="{Binding ResourceService}"
                    EngagementService="{Binding EngagementService}"
                    ProjectManager="{Binding ProjectManager}"
                    ColumnWidth="{Binding ColumnWidth, Mode=OneWay}"
                    ShowResourceNames="False"/>
            </Border>
        </Grid>
    </DockPanel>
</Window>