<Window x:Class="Wpf.Views.ResourceManagerDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:Wpf.Converters"
        mc:Ignorable="d"
        Title="Управление ресурсами"
        Height="900"
        Width="900"
        MinHeight="500"
        MinWidth="600"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        ResizeMode="CanResize"
        Background="{StaticResource BackgroundBrush}">

    <Window.Resources>
        <converters:HexToColorConverter x:Key="HexToColorConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NotNullToBoolConverter x:Key="NotNullToBoolConverter"/>
        <converters:BoolToEditModeHeaderConverter x:Key="BoolToEditModeHeaderConverter"/>
        <converters:BoolToSaveAddConverter x:Key="BoolToSaveAddConverter"/>
        <converters:EnumToDisplayNameConverter x:Key="EnumToDisplayNameConverter"/>
        <converters:TimeSpanDateConverter x:Key="TimeSpanDateConverter"/>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="360"/>
        </Grid.ColumnDefinitions>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- СПИСОК РЕСУРСОВ                                                 -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <GroupBox Grid.Row="0" Grid.Column="0" 
                  Header="Ресурсы" 
                  Margin="0,0,8,0">
            <DataGrid x:Name="ResourcesGrid"
                      ItemsSource="{Binding Resources}"
                      SelectedItem="{Binding SelectedResource, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      SelectionUnit="FullRow"
                      GridLinesVisibility="Horizontal"
                      HorizontalGridLinesBrush="{StaticResource GridLineBrush}"
                      Background="{StaticResource BackgroundBrush}"
                      RowHeight="32"
                      HeadersVisibility="Column">
                
                <DataGrid.Columns>
                    <!-- Цвет -->
                    <DataGridTemplateColumn Header="" Width="30">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Width="20" Height="20" 
                                        CornerRadius="3"
                                        BorderBrush="{StaticResource GridLineBrush}"
                                        BorderThickness="1"
                                        HorizontalAlignment="Center">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding ColorHex, 
                                            Converter={StaticResource HexToColorConverter}, 
                                            FallbackValue=#4682B4}"/>
                                    </Border.Background>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <!-- Инициалы -->
                    <DataGridTextColumn Header="Инициалы" 
                                        Binding="{Binding Initials}" 
                                        Width="80"/>
                    
                    <!-- Имя -->
                    <DataGridTextColumn Header="Имя" 
                                        Binding="{Binding Name}" 
                                        Width="*"/>
                    
                    <!-- Роль -->
                    <DataGridTextColumn Header="Роль" 
                                        Binding="{Binding Role, Converter={StaticResource EnumToDisplayNameConverter}}" 
                                        Width="150"/>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- ФОРМА РЕДАКТИРОВАНИЯ                                            -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <GroupBox Grid.Row="0" Grid.Column="1" 
                  Header="{Binding IsEditMode, Converter={StaticResource BoolToEditModeHeaderConverter}}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="8">
                
                    <!-- Имя -->
                    <TextBlock Text="Имя:" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,12"/>

                    <!-- Инициалы -->
                    <TextBlock Text="Инициалы:" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding EditInitials, UpdateSourceTrigger=PropertyChanged}"
                             MaxLength="12"
                             Margin="0,0,0,12"/>

                    <!-- Роль -->
                    <TextBlock Text="Роль:" Margin="0,0,0,4"/>
                    <ComboBox SelectedItem="{Binding EditRole}"
                              ItemsSource="{Binding AvailableRoles}"
                              Margin="0,0,0,12">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource EnumToDisplayNameConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!-- Цвет -->
                    <TextBlock Text="Цвет:" Margin="0,0,0,4"/>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>
                    
                        <TextBox Grid.Column="0" 
                                 Text="{Binding EditColorHex, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,8,0"/>
                    
                        <Border Grid.Column="1" 
                                CornerRadius="3"
                                BorderBrush="{StaticResource GridLineBrush}"
                                BorderThickness="1">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding EditColorHex, 
                                    Converter={StaticResource HexToColorConverter}, 
                                    FallbackValue=#4682B4}"/>
                            </Border.Background>
                        </Border>
                    </Grid>

                    <!-- Предустановленные цвета -->
                    <TextBlock Text="Быстрый выбор:" Margin="0,0,0,4" FontSize="11" 
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                    <WrapPanel Margin="0,0,0,16">
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#4682B4" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#3A6E9A"/>
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#2E8B57" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#246B45"/>
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#CD5C5C" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#A34A4A"/>
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#9370DB" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#7558B0"/>
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#FF8C00" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#CC7000"/>
                        <Button Content="" Width="24" Height="24" Margin="2" Background="#20B2AA" Click="ColorButton_Click" BorderThickness="1" BorderBrush="#198E88"/>
                    </WrapPanel>

                    <!-- Кнопки действий -->
                    <Button x:Name="SaveAddButton"
                            Content="{Binding IsEditMode, Converter={StaticResource BoolToSaveAddConverter}}"
                            Click="SaveOrAddButton_Click"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Margin="0,0,0,8"/>
                
                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <!-- ИНТЕРВАЛЫ УЧАСТИЯ (только в режиме редактирования)          -->
                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <Expander Header="Интервалы участия" 
                              IsExpanded="False"
                              Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}"
                              Margin="0,8,0,8">
                        <StackPanel>
                            <DataGrid ItemsSource="{Binding ParticipationIntervals}"
                                      SelectedItem="{Binding SelectedInterval}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      Height="120"
                                      Margin="0,4,0,4">
                                <DataGrid.Columns>
                                    <!-- Дата начала -->
                                    <DataGridTemplateColumn Header="С" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Start, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    StringFormat=d}"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <DatePicker SelectedDate="{Binding Start, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    UpdateSourceTrigger=PropertyChanged}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <!-- Дата окончания (nullable) -->
                                    <DataGridTemplateColumn Header="По" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock VerticalAlignment="Center" Margin="4,0">
                                                    <TextBlock.Text>
                                                        <Binding Path="End" 
                                                                 Converter="{StaticResource TimeSpanDateConverter}"
                                                                 StringFormat="d"
                                                                 TargetNullValue="∞"/>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <DatePicker SelectedDate="{Binding End, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    UpdateSourceTrigger=PropertyChanged}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <!-- MaxWorkload -->
                                    <DataGridTextColumn Header="MaxWL%" 
                                                        Binding="{Binding MaxWorkload}" 
                                                        Width="60"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="+" Width="28" Height="28" 
                                        Command="{Binding AddIntervalCommand}"
                                        ToolTip="Добавить интервал"
                                        Margin="0,0,4,0"/>
                                <Button Content="×" Width="28" Height="28" 
                                        Command="{Binding RemoveIntervalCommand}"
                                        ToolTip="Удалить интервал"
                                        Foreground="#D32F2F"/>
                            </StackPanel>
                        </StackPanel>
                    </Expander>

                    <!-- ОТСУТСТВИЯ (только в режиме редактирования)                 -->
                    <Expander Header="Отсутствия" 
                              IsExpanded="False"
                              Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}"
                              Margin="0,0,0,8">
                        <StackPanel>
                            <DataGrid ItemsSource="{Binding Absences}"
                                      SelectedItem="{Binding SelectedAbsence}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      Height="120"
                                      Margin="0,4,0,4">
                                <DataGrid.Columns>
                                    <!-- Дата начала -->
                                    <DataGridTemplateColumn Header="С" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Start, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    StringFormat=d}"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <DatePicker SelectedDate="{Binding Start, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    UpdateSourceTrigger=PropertyChanged}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <!-- Дата окончания -->
                                    <DataGridTemplateColumn Header="По" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding End, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    StringFormat=d}"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <DatePicker SelectedDate="{Binding End, 
                                                    Converter={StaticResource TimeSpanDateConverter},
                                                    UpdateSourceTrigger=PropertyChanged}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <!-- Причина -->
                                    <DataGridComboBoxColumn Header="Причина" 
                                                            SelectedItemBinding="{Binding Reason}"
                                                            Width="*">
                                        <DataGridComboBoxColumn.ItemsSource>
                                            <x:Array Type="sys:String" 
                                                     xmlns:sys="clr-namespace:System;assembly=mscorlib">
                                                <sys:String>Отпуск</sys:String>
                                                <sys:String>Болезнь</sys:String>
                                                <sys:String>Командировка</sys:String>
                                                <sys:String>Отгул</sys:String>
                                                <sys:String>Другое</sys:String>
                                            </x:Array>
                                        </DataGridComboBoxColumn.ItemsSource>
                                    </DataGridComboBoxColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="+" Width="28" Height="28" 
                                        Command="{Binding AddAbsenceCommand}"
                                        ToolTip="Добавить отсутствие"
                                        Margin="0,0,4,0"/>
                                <Button Content="×" Width="28" Height="28" 
                                        Command="{Binding RemoveAbsenceCommand}"
                                        ToolTip="Удалить отсутствие"
                                        Foreground="#D32F2F"/>
                            </StackPanel>
                        </StackPanel>
                    </Expander>
                
                    <Button Content="Редактировать"
                            Command="{Binding EditResourceCommand}"
                            IsEnabled="{Binding SelectedResource, Converter={StaticResource NotNullToBoolConverter}}"
                            Margin="0,0,0,8"/>

                    <Button Content="Удалить"
                            Command="{Binding DeleteResourceCommand}"
                            IsEnabled="{Binding SelectedResource, Converter={StaticResource NotNullToBoolConverter}}"
                            Foreground="#D32F2F"
                            Margin="0,0,0,8"/>

                    <Button Content="Отмена"
                            Command="{Binding CancelEditCommand}"
                            Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </ScrollViewer>
        </GroupBox>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- СТАТУС                                                          -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                   Text="{Binding StatusMessage}"
                   Foreground="{StaticResource TextSecondaryBrush}"
                   Margin="0,8,0,8"/>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- КНОПКА ЗАКРЫТЬ                                                  -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right">
            <Button Content="Закрыть" 
                    Width="100"
                    Padding="16,8"
                    Click="CloseButton_Click"/>
        </StackPanel>
    </Grid>
</Window>